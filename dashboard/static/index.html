<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸš¦ OpenClaw Trading OS</title>
  <script src="https://unpkg.com/lightweight-charts@4.2.0/dist/lightweight-charts.standalone.production.js"></script>
  <style>
    :root {
      --bg:       #0d1117;
      --surface:  #161b22;
      --border:   #30363d;
      --text:     #e6edf3;
      --muted:    #8b949e;
      --green:    #3fb950;
      --red:      #f85149;
      --blue:     #58a6ff;
      --yellow:   #e3b341;
      --accent:   #1f6feb;
    }
    * { margin:0; padding:0; box-sizing:border-box; }
    body { background:var(--bg); color:var(--text); font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',monospace; font-size:13px; height:100vh; overflow:hidden; }

    /* â”€â”€ é¡¶æ  â”€â”€ */
    .topbar {
      height:48px; background:var(--surface); border-bottom:1px solid var(--border);
      display:flex; align-items:center; padding:0 16px; gap:16px; flex-shrink:0;
    }
    .logo { font-size:16px; font-weight:700; color:var(--blue); white-space:nowrap; }
    .search-wrap { display:flex; gap:6px; flex:1; max-width:400px; position:relative; }
    .search-wrap input {
      flex:1; background:#010409; border:1px solid var(--border); border-radius:6px;
      color:var(--text); padding:6px 10px; font-size:13px; outline:none;
    }
    .search-wrap input:focus { border-color:var(--blue); }
    
    /* æœç´¢æç¤ºä¸‹æ‹‰æ¡† */
    .search-dropdown {
      position:absolute; top:100%; left:0; right:60px; margin-top:4px;
      background:var(--surface); border:1px solid var(--border); border-radius:8px;
      box-shadow:0 8px 24px rgba(0,0,0,0.4); max-height:300px; overflow-y:auto;
      display:none; z-index:1000;
    }
    .search-dropdown.show { display:block; }
    .search-item {
      display:flex; align-items:center; padding:10px 12px; cursor:pointer;
      border-bottom:1px solid var(--border); gap:12px;
    }
    .search-item:last-child { border-bottom:none; }
    .search-item:hover { background:rgba(88,166,255,.1); }
    .search-item .symbol { font-weight:700; font-size:14px; min-width:80px; }
    .search-item .name { color:var(--muted); font-size:12px; flex:1; }
    .search-item .market {
      font-size:10px; padding:2px 6px; border-radius:4px;
      background:var(--border); color:var(--muted);
    }
    .search-item .market.US { background:rgba(88,166,255,.2); color:var(--blue); }
    .search-item .market.HK { background:rgba(248,81,73,.2); color:var(--red); }
    .search-item .market.Crypto { background:rgba(227,179,65,.2); color:var(--yellow); }
    .btn {
      background:var(--accent); color:#fff; border:none; border-radius:6px;
      padding:6px 12px; cursor:pointer; font-size:12px; font-weight:600; white-space:nowrap;
    }
    .btn:hover { opacity:.85; }
    .btn.ghost { background:transparent; border:1px solid var(--border); color:var(--text); }
    .btn.ghost:hover { border-color:var(--blue); color:var(--blue); }
    .pill {
      font-size:11px; padding:2px 8px; border-radius:20px; font-weight:600;
      background:rgba(63,185,80,.15); color:var(--green);
    }
    .pill.red { background:rgba(248,81,73,.15); color:var(--red); }
    .status-dot { width:8px; height:8px; border-radius:50%; background:var(--green); display:inline-block; margin-right:4px; animation:pulse 2s infinite; }
    @keyframes pulse { 0%,100%{opacity:1}50%{opacity:.4} }

    /* â”€â”€ ä¸»å¸ƒå±€ â”€â”€ */
    .layout {
      display:grid;
      grid-template-columns: 220px 1fr 280px;
      height: calc(100vh - 48px);
    }

    /* â”€â”€ å·¦ä¾§æ  â”€â”€ */
    .sidebar {
      background:var(--surface); border-right:1px solid var(--border);
      display:flex; flex-direction:column; overflow:hidden;
    }
    .sidebar-section { padding:12px; border-bottom:1px solid var(--border); }
    .sidebar-title { font-size:11px; font-weight:700; color:var(--muted); text-transform:uppercase; letter-spacing:.05em; margin-bottom:8px; }
    .watchlist-item {
      display:flex; justify-content:space-between; align-items:center;
      padding:7px 8px; border-radius:6px; cursor:pointer; margin-bottom:2px;
      border:1px solid transparent; transition:all .15s;
    }
    .watchlist-item:hover { background:rgba(88,166,255,.08); border-color:rgba(88,166,255,.2); }
    .watchlist-item.active { background:rgba(88,166,255,.12); border-color:rgba(88,166,255,.35); }
    .wl-sym { font-weight:700; font-size:13px; }
    .wl-price { font-size:12px; color:var(--text); }
    .wl-chg { font-size:11px; font-weight:600; }
    .wl-remove { color:var(--muted); font-size:14px; cursor:pointer; opacity:0; padding:0 4px; }
    .watchlist-item:hover .wl-remove { opacity:1; }
    .empty-msg { color:var(--muted); font-size:12px; text-align:center; padding:16px 0; }

    .quick-btn { width:100%; margin-bottom:6px; text-align:left; padding:7px 10px; font-size:12px; }

    /* â”€â”€ ä¸»å†…å®¹ â”€â”€ */
    .main { display:flex; flex-direction:column; overflow:hidden; }
    .chart-header {
      padding:10px 16px; background:var(--surface); border-bottom:1px solid var(--border);
      display:flex; align-items:center; gap:16px; flex-shrink:0;
    }
    .chart-sym { font-size:18px; font-weight:800; }
    .chart-price { font-size:22px; font-weight:700; }
    .chart-meta { color:var(--muted); font-size:12px; }
    .period-btns { display:flex; gap:4px; margin-left:auto; }
    .period-btn {
      background:transparent; border:1px solid var(--border); color:var(--muted);
      border-radius:4px; padding:3px 10px; cursor:pointer; font-size:12px;
    }
    .period-btn.active, .period-btn:hover { border-color:var(--blue); color:var(--blue); }

    #chart-container { flex:1; position:relative; }

    /* â”€â”€ å³ä¾§æ  â”€â”€ */
    .panel {
      background:var(--surface); border-left:1px solid var(--border);
      display:flex; flex-direction:column; overflow:hidden;
    }
    .panel-tabs { display:flex; border-bottom:1px solid var(--border); flex-shrink:0; }
    .panel-tab {
      flex:1; padding:10px; text-align:center; cursor:pointer; color:var(--muted);
      font-size:12px; font-weight:600; border-bottom:2px solid transparent;
    }
    .panel-tab.active { color:var(--blue); border-bottom-color:var(--blue); }
    .panel-body { flex:1; overflow-y:auto; padding:12px; display:flex; flex-direction:column; }

    /* AI Chat */
    .chat-messages { flex:1; overflow-y:auto; display:flex; flex-direction:column; gap:8px; margin-bottom:8px; min-height:0; }
    .msg { padding:8px 10px; border-radius:8px; max-width:100%; font-size:12px; line-height:1.5; }
    .msg.user { background:var(--accent); color:#fff; align-self:flex-end; border-radius:8px 8px 2px 8px; }
    .msg.ai { background:#21262d; color:var(--text); align-self:flex-start; border-radius:8px 8px 8px 2px; }
    .msg.ai b { color:var(--yellow); }
    .msg.ai .score { display:inline-block; width:10px; height:10px; border-radius:50%; margin-right:4px; }
    .msg-loading { color:var(--muted); font-style:italic; }
    .chat-input-wrap { display:flex; gap:6px; flex-shrink:0; }
    .chat-input {
      flex:1; background:#010409; border:1px solid var(--border); border-radius:6px;
      color:var(--text); padding:8px 10px; font-size:12px; outline:none; resize:none; min-height:38px; max-height:80px;
    }
    .chat-input:focus { border-color:var(--blue); }

    /* Analysis result */
    .analysis-card { background:#21262d; border-radius:8px; padding:12px; margin-bottom:8px; }
    .analysis-card h4 { font-size:12px; color:var(--blue); margin-bottom:8px; text-transform:uppercase; letter-spacing:.05em; }
    .score-bar { display:flex; align-items:center; gap:8px; margin-bottom:6px; }
    .score-label { width:90px; font-size:11px; color:var(--muted); }
    .score-track { flex:1; height:6px; background:#30363d; border-radius:3px; overflow:hidden; }
    .score-fill { height:100%; border-radius:3px; transition:width .5s; }
    .score-val { width:32px; font-size:11px; text-align:right; font-weight:700; }

    /* Agent feed */
    .feed-item { padding:8px; border-left:2px solid var(--border); margin-bottom:6px; font-size:11px; }
    .feed-item.critical { border-color:var(--red); }
    .feed-item.info { border-color:var(--blue); }
    .feed-item.success { border-color:var(--green); }
    .feed-time { color:var(--muted); font-size:10px; }

    /* Scrollbar */
    ::-webkit-scrollbar { width:4px; }
    ::-webkit-scrollbar-track { background:transparent; }
    ::-webkit-scrollbar-thumb { background:var(--border); border-radius:2px; }
  </style>
</head>
<body>

<!-- â”€â”€ é¡¶æ  â”€â”€ -->
<div class="topbar">
  <div class="logo">ğŸš¦ Trading OS</div>
  <div class="search-wrap">
    <input id="search-input" type="text" placeholder="æœç´¢è‚¡ç¥¨ (AAPL, è…¾è®¯, BTC...)" autocomplete="off" />
    <button class="btn" onclick="addSymbol()">+ æ·»åŠ </button>
    <div class="search-dropdown" id="search-dropdown"></div>
  </div>
  <span style="color:var(--muted);font-size:12px;"><span class="status-dot"></span>å®æ—¶</span>
</div>

<!-- â”€â”€ ä¸»å¸ƒå±€ â”€â”€ -->
<div class="layout">

  <!-- å·¦ä¾§ï¼šè‡ªé€‰è‚¡ + å¿«æ·æ“ä½œ -->
  <div class="sidebar">
    <div class="sidebar-section" style="flex:1;overflow-y:auto;min-height:0">
      <div class="sidebar-title">è‡ªé€‰è‚¡</div>
      <div id="watchlist-container">
        <div class="empty-msg">è¾“å…¥ä»£ç åç‚¹å‡»ã€Œ+ æ·»åŠ ã€</div>
      </div>
    </div>
    <div class="sidebar-section">
      <div class="sidebar-title">å¿«æ·æ“ä½œ</div>
      <button class="btn ghost quick-btn" onclick="loadHot()">ğŸ”¥ çƒ­ç‚¹æ‰«æ</button>
      <button class="btn ghost quick-btn" onclick="analyzeActive()">ğŸ¤– AI åˆ†æ</button>
      <button class="btn ghost quick-btn" onclick="addDemo()">ğŸ“‹ åŠ è½½ç¤ºä¾‹</button>
    </div>
  </div>

  <!-- ä¸»åŒºï¼šå›¾è¡¨ -->
  <div class="main">
    <div class="chart-header">
      <div>
        <span class="chart-sym" id="chart-sym">--</span>
        <span class="chart-meta" id="chart-name" style="margin-left:8px"></span>
      </div>
      <div>
        <span class="chart-price" id="chart-price">--</span>
        <span id="chart-chg" style="margin-left:8px;font-size:14px;font-weight:600"></span>
      </div>
      <div class="period-btns">
        <button class="period-btn active" onclick="changePeriod('1d',this)">1D</button>
        <button class="period-btn" onclick="changePeriod('5d',this)">5D</button>
        <button class="period-btn" onclick="changePeriod('1mo',this)">1M</button>
        <button class="period-btn" onclick="changePeriod('3mo',this)">3M</button>
      </div>
    </div>
    <div id="chart-container"></div>
  </div>

  <!-- å³ä¾§ï¼šAI é¢æ¿ -->
  <div class="panel">
    <div class="panel-tabs">
      <div class="panel-tab active" onclick="switchTab('chat',this)">ğŸ¤– AI åŠ©æ‰‹</div>
      <div class="panel-tab" onclick="switchTab('analysis',this)">ğŸ“Š åˆ†æ</div>
      <div class="panel-tab" onclick="switchTab('feed',this)">ğŸ“¡ åŠ¨æ€</div>
    </div>

    <!-- Chat Tab -->
    <div class="panel-body" id="tab-chat">
      <!-- OpenClaw å¿«æ·å…¥å£ -->
      <div style="padding:8px 0;border-bottom:1px solid var(--border);margin-bottom:8px;display:flex;gap:8px;align-items:center;">
        <button class="btn" onclick="window.open('http://127.0.0.1:18789/','_blank')" style="flex:1;">
          ğŸ¦ æ‰“å¼€ OpenClaw å®Œæ•´ç‰ˆ
        </button>
        <span style="font-size:11px;color:var(--muted);">å…¨éƒ¨å·¥å…·</span>
      </div>
      
      <!-- å†…ç½® AI èŠå¤© -->
      <div class="chat-messages" id="chat-messages">
        <div class="msg ai">
          ğŸ¦ <b>é¾™è™¾äº¤æ˜“åŠ©æ‰‹</b> å·²ä¸Šçº¿ï¼<br><br>
          æˆ‘æ˜¯æ¨ªè·¨ <b>æ¸¯è‚¡ğŸ‡­ğŸ‡° ç¾è‚¡ğŸ‡ºğŸ‡¸ CryptoğŸª™</b> çš„å¤šè¾¹å½¢äº¤æ˜“æˆ˜å£«ï¼Œä¹Ÿæ˜¯ <b>MuQuant</b> é‡åŒ–ç³»ç»Ÿçš„æ­å»ºè€…ã€‚<br><br>
          <b>ğŸ”¥ å¸¸ç”¨æŒ‡ä»¤ï¼š</b><br>
          â€¢ <code>åˆ†æ AAPL</code> â€” æŠ€æœ¯é¢+åŸºæœ¬é¢åˆ†æ<br>
          â€¢ <code>æœç´¢ è…¾è®¯è´¢æŠ¥</code> â€” å®æ—¶èµ„è®¯æŠ“å–<br>
          â€¢ <code>BTCä»·æ ¼</code> â€” åŠ å¯†è´§å¸è¡Œæƒ…<br>
          â€¢ <code>çƒ­ç‚¹</code> â€” æ‰«æå¸‚åœºçƒ­ç‚¹<br>
          â€¢ <code>é¢„è­¦ AAPL 200</code> â€” ä»·æ ¼æé†’<br><br>
          <span style="color:var(--muted);font-size:11px;">ğŸ’¡ ç›´æ¥è¾“å…¥é—®é¢˜ï¼Œæˆ‘éšæ—¶ä¸ºä½ åˆ†æï¼</span>
        </div>
      </div>
      <div class="chat-input-wrap">
        <textarea class="chat-input" id="chat-input" placeholder="é—® AI åŠ©æ‰‹..." rows="1"
          onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendChat()}"
        ></textarea>
        <button class="btn" onclick="sendChat()">å‘é€</button>
      </div>
    </div>

    <!-- Analysis Tab -->
    <div class="panel-body" id="tab-analysis" style="display:none">
      <div id="analysis-content">
        <div class="empty-msg" style="margin-top:24px">é€‰æ‹©æ ‡çš„åç‚¹å‡»ã€ŒğŸ¤– AI åˆ†æã€</div>
      </div>
    </div>

    <!-- Feed Tab -->
    <div class="panel-body" id="tab-feed" style="display:none">
      <div id="feed-content">
        <div class="feed-item info">
          <div class="feed-time">å¯åŠ¨ä¸­</div>
          OpenClaw Trading OS å·²è¿æ¥
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// â”€â”€ çŠ¶æ€ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let activeSymbol = '';
let chart = null;
let candleSeries = null;
let volSeries = null;
let currentPeriod = '1d';
let ws = null;
let prices = {}; // {symbol: priceData}

// â”€â”€ å›¾è¡¨åˆå§‹åŒ– â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initChart() {
  const container = document.getElementById('chart-container');
  chart = LightweightCharts.createChart(container, {
    layout: { background: { color: '#0d1117' }, textColor: '#8b949e' },
    grid: { vertLines: { color: '#1c2128' }, horzLines: { color: '#1c2128' } },
    crosshair: { mode: LightweightCharts.CrosshairMode.Normal },
    rightPriceScale: { borderColor: '#30363d' },
    timeScale: { borderColor: '#30363d', timeVisible: true },
    width: container.offsetWidth,
    height: container.offsetHeight,
  });

  candleSeries = chart.addCandlestickSeries({
    upColor: '#3fb950', downColor: '#f85149',
    borderUpColor: '#3fb950', borderDownColor: '#f85149',
    wickUpColor: '#3fb950', wickDownColor: '#f85149',
  });

  window.addEventListener('resize', () => {
    chart.resize(container.offsetWidth, container.offsetHeight);
  });
}

// â”€â”€ åŠ è½½å›¾è¡¨æ•°æ® â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadChart(symbol, period) {
  if (!symbol) return;
  try {
    const r = await fetch(`/api/chart/${symbol}?period=${period}`);
    const data = await r.json();
    if (!data.data || !data.data.length) return;

    const candles = data.data.map(d => ({
      time: Math.floor(new Date(d.date).getTime() / 1000),
      open: d.open, high: d.high, low: d.low, close: d.close,
    })).filter(d => d.open && d.high && d.low && d.close)
       .sort((a, b) => a.time - b.time);

    if (candles.length) {
      candleSeries.setData(candles);
      chart.timeScale().fitContent();
    }
  } catch(e) { console.error('Chart load error:', e); }
}

// â”€â”€ åŠ è½½ä»·æ ¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadPrice(symbol) {
  try {
    const r = await fetch(`/api/price/${symbol}`);
    const d = await r.json();
    if (d.error) return;
    prices[symbol] = d;
    if (symbol === activeSymbol) updateHeader(d);
    return d;
  } catch(e) {}
}

function updateHeader(d) {
  document.getElementById('chart-sym').textContent = d.symbol || '';
  document.getElementById('chart-name').textContent = d.name || '';
  const price = d.price ? d.price.toFixed(d.price > 100 ? 2 : 4) : '--';
  document.getElementById('chart-price').textContent = `${d.currency || ''} ${price}`;
  const chg = d.change_pct;
  const chgEl = document.getElementById('chart-chg');
  if (chg !== undefined) {
    const sign = chg >= 0 ? '+' : '';
    chgEl.textContent = `${sign}${chg.toFixed(2)}%`;
    chgEl.style.color = chg >= 0 ? 'var(--green)' : 'var(--red)';
  }
}

// â”€â”€ è‡ªé€‰è‚¡ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadWatchlist() {
  try {
    const r = await fetch('/api/watchlist');
    const items = await r.json();
    renderWatchlist(items);
    // å¦‚æœè‡ªé€‰è‚¡ä¸ºç©ºï¼Œè®¾ç½®é»˜è®¤å±•ç¤º AAPL
    if (items.length === 0 && !activeSymbol) {
      selectSymbol('AAPL');
    } else if (items.length > 0 && !activeSymbol) {
      selectSymbol(items[0].symbol);
    }
  } catch(e) {}
}

function renderWatchlist(items) {
  const container = document.getElementById('watchlist-container');
  if (!items.length) {
    container.innerHTML = '<div class="empty-msg">è¾“å…¥ä»£ç åç‚¹å‡»ã€Œ+ æ·»åŠ ã€</div>';
    return;
  }
  container.innerHTML = items.map(item => {
    const chg = item.change_pct;
    const sign = chg >= 0 ? '+' : '';
    const cls = chg >= 0 ? 'var(--green)' : 'var(--red)';
    const price = item.price ? item.price.toFixed(item.price > 100 ? 2 : 4) : '--';
    return `
      <div class="watchlist-item ${item.symbol === activeSymbol ? 'active' : ''}"
           onclick="selectSymbol('${item.symbol}')" id="wl-${item.symbol}">
        <div>
          <div class="wl-sym">${item.symbol}</div>
          <div style="font-size:10px;color:var(--muted)">${item.name || ''}</div>
        </div>
        <div style="text-align:right">
          <div class="wl-price">${price}</div>
          <div class="wl-chg" style="color:${cls}">${sign}${chg !== undefined ? chg.toFixed(2) : '--'}%</div>
        </div>
        <span class="wl-remove" onclick="event.stopPropagation();removeSymbol('${item.symbol}')">Ã—</span>
      </div>`;
  }).join('');
}

async function selectSymbol(symbol) {
  activeSymbol = symbol;
  // æ›´æ–° active æ ·å¼
  document.querySelectorAll('.watchlist-item').forEach(el => el.classList.remove('active'));
  const el = document.getElementById(`wl-${symbol}`);
  if (el) el.classList.add('active');
  // åŠ è½½ä»·æ ¼ + å›¾è¡¨
  await Promise.all([loadPrice(symbol), loadChart(symbol, currentPeriod)]);
}

// â”€â”€ æœç´¢æç¤ºåŠŸèƒ½ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let searchTimeout = null;
const searchInput = document.getElementById('search-input');
const searchDropdown = document.getElementById('search-dropdown');

searchInput.addEventListener('input', (e) => {
  const q = e.target.value.trim();
  clearTimeout(searchTimeout);
  
  if (q.length < 1) {
    searchDropdown.classList.remove('show');
    return;
  }
  
  searchTimeout = setTimeout(() => doSearch(q), 150);
});

searchInput.addEventListener('focus', () => {
  const q = searchInput.value.trim();
  if (q.length >= 1) doSearch(q);
});

searchInput.addEventListener('blur', () => {
  // å»¶è¿Ÿéšè—ï¼Œè®©ç‚¹å‡»äº‹ä»¶å…ˆè§¦å‘
  setTimeout(() => searchDropdown.classList.remove('show'), 200);
});

async function doSearch(q) {
  try {
    const r = await fetch(`/api/search?q=${encodeURIComponent(q)}`);
    const items = await r.json();
    
    if (!items.length) {
      // æ²¡æœ‰åŒ¹é…ç»“æœï¼Œä½†å¦‚æœè¾“å…¥çœ‹èµ·æ¥æ˜¯æœ‰æ•ˆä»£ç ï¼Œæ˜¾ç¤ºæç¤º
      if (q.length >= 2) {
        searchDropdown.innerHTML = `
          <div class="search-item" onclick="selectSearchItem('${q.toUpperCase()}')">
            <span class="symbol">${q.toUpperCase()}</span>
            <span class="name">æŒ‰å›è½¦æ·»åŠ æ­¤ä»£ç </span>
          </div>`;
        searchDropdown.classList.add('show');
      } else {
        searchDropdown.classList.remove('show');
      }
      return;
    }
    
    searchDropdown.innerHTML = items.map(item => `
      <div class="search-item" onclick="selectSearchItem('${item.symbol}')">
        <span class="symbol">${item.symbol}</span>
        <span class="name">${item.name}</span>
        <span class="market ${item.market}">${item.market}</span>
      </div>
    `).join('');
    searchDropdown.classList.add('show');
  } catch(e) {
    console.error('Search error:', e);
  }
}

function selectSearchItem(symbol) {
  searchInput.value = symbol;
  searchDropdown.classList.remove('show');
  addSymbol();
}

async function addSymbol() {
  const input = document.getElementById('search-input');
  const sym = input.value.trim().toUpperCase();
  if (!sym) return;
  
  searchDropdown.classList.remove('show');
  addFeedItem('info', `æ­£åœ¨æ·»åŠ  ${sym}...`);
  
  try {
    const r = await fetch(`/api/watchlist/${sym}`, { method: 'POST' });
    const data = await r.json();
    if (data.success) {
      input.value = '';
      addFeedItem('success', `âœ… ${sym} å·²åŠ å…¥è‡ªé€‰è‚¡`);
      await loadWatchlist();
      selectSymbol(sym);
    } else {
      addFeedItem('critical', `âŒ ${data.message}`);
    }
  } catch(e) {
    addFeedItem('critical', `âŒ æ·»åŠ å¤±è´¥: ${e.message}`);
  }
}

async function removeSymbol(symbol) {
  await fetch(`/api/watchlist/${symbol}`, { method: 'DELETE' });
  addFeedItem('info', `ç§»é™¤ ${symbol}`);
  if (activeSymbol === symbol) activeSymbol = '';
  await loadWatchlist();
}

async function changePeriod(period, btn) {
  document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  currentPeriod = period;
  if (activeSymbol) await loadChart(activeSymbol, period);
}

// â”€â”€ å¿«æ·æ“ä½œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function analyzeActive() {
  const sym = activeSymbol || 'AAPL';
  switchTab('analysis', document.querySelectorAll('.panel-tab')[1]);
  document.getElementById('analysis-content').innerHTML = '<div class="empty-msg msg-loading">åˆ†æä¸­... â³</div>';
  addFeedItem('info', `ğŸ¤– æ­£åœ¨åˆ†æ ${sym}...`);
  try {
    const r = await fetch(`/api/analyze/${sym}`);
    const data = await r.json();
    renderAnalysis(sym, data);
    addFeedItem('success', `âœ… ${sym} åˆ†æå®Œæˆ`);
  } catch(e) {
    document.getElementById('analysis-content').innerHTML = '<div class="empty-msg">åˆ†æå¤±è´¥ï¼Œè¯·é‡è¯•</div>';
  }
}

function renderAnalysis(symbol, data) {
  if (data.error) {
    document.getElementById('analysis-content').innerHTML = `<div class="empty-msg">${data.error}</div>`;
    return;
  }

  // å°è¯•ä»è¿”å›æ•°æ®æå–è¯„åˆ†
  const result = data[0] || data;
  const score = result.total_score || result.score || 0;
  const rec = result.recommendation || result.signal || 'HOLD';
  const dims = result.dimensions || result.scores || {};

  const recColor = rec === 'BUY' ? 'var(--green)' : rec === 'SELL' ? 'var(--red)' : 'var(--yellow)';

  const dimLabels = {
    earnings_surprise: 'è´¢æŠ¥æƒŠå–œ',
    fundamentals: 'åŸºæœ¬é¢',
    analyst_sentiment: 'åˆ†æå¸ˆ',
    market_context: 'å¸‚åœºç¯å¢ƒ',
    momentum: 'åŠ¨é‡',
    sector_relative: 'æ¿å—',
    historical: 'å†å²',
    sentiment: 'æƒ…ç»ª',
  };

  const dimHtml = Object.entries(dims).map(([key, val]) => {
    const pct = Math.min(100, Math.max(0, (val + 1) / 2 * 100)); // å½’ä¸€åŒ– -1~1 â†’ 0~100
    const color = val >= 0 ? 'var(--green)' : 'var(--red)';
    return `
      <div class="score-bar">
        <div class="score-label">${dimLabels[key] || key}</div>
        <div class="score-track"><div class="score-fill" style="width:${pct}%;background:${color}"></div></div>
        <div class="score-val" style="color:${color}">${(val * 100).toFixed(0)}</div>
      </div>`;
  }).join('');

  document.getElementById('analysis-content').innerHTML = `
    <div class="analysis-card">
      <h4>${symbol} ç»¼åˆè¯„åˆ†</h4>
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">
        <div style="font-size:28px;font-weight:800;color:${recColor}">${(score * 100).toFixed(0)}</div>
        <div>
          <div style="font-size:16px;font-weight:700;color:${recColor}">${rec}</div>
          <div style="font-size:11px;color:var(--muted)">ç»¼åˆå»ºè®®</div>
        </div>
      </div>
      ${dimHtml || '<div style="color:var(--muted);font-size:12px">è¯¦ç»†è¯„åˆ†ä¸å¯ç”¨</div>'}
    </div>
    ${result.ai_summary ? `<div class="analysis-card"><h4>AI è§£è¯»</h4><div style="font-size:12px;line-height:1.6;color:var(--text)">${result.ai_summary}</div></div>` : ''}
    <div style="font-size:10px;color:var(--muted);text-align:center;margin-top:8px">âš ï¸ ä»…ä¾›å‚è€ƒï¼Œä¸æ„æˆæŠ•èµ„å»ºè®®</div>
  `;
}

async function loadHot() {
  addFeedItem('info', 'ğŸ”¥ æ­£åœ¨æ‰«æçƒ­ç‚¹...');
  switchTab('feed', document.querySelectorAll('.panel-tab')[2]);
  try {
    const r = await fetch('/api/hot');
    const data = await r.json();
    if (data.trending) {
      data.trending.slice(0, 8).forEach(item => {
        addFeedItem('success', `ğŸ”¥ ${item.symbol || item.name} â€” ${item.reason || 'çƒ­é—¨'}`);
      });
    } else if (data.error) {
      addFeedItem('critical', `çƒ­ç‚¹æ‰«æ: ${data.error}`);
    }
  } catch(e) { addFeedItem('critical', 'çƒ­ç‚¹æ‰«æå¤±è´¥'); }
}

async function addDemo() {
  const demos = ['AAPL', 'NVDA', 'BTC-USD'];
  for (const sym of demos) {
    await fetch(`/api/watchlist/${sym}`, { method: 'POST' });
  }
  await loadWatchlist();
  addFeedItem('success', 'âœ… ç¤ºä¾‹æ ‡çš„å·²åŠ è½½');
}

// â”€â”€ AI Chat â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function sendChat() {
  const input = document.getElementById('chat-input');
  const text = input.value.trim();
  if (!text) return;
  input.value = '';

  appendMsg('user', text);

  // è§£æè‚¡ç¥¨ä»£ç  - æ›´æ™ºèƒ½çš„åŒ¹é…
  const upper = text.toUpperCase();
  // åŒ¹é…: AAPL, BTC-USD, 0700.HK, 2399.HK, æ¸¯è‚¡2399 ç­‰
  let ticker = null;
  
  // æ˜ç¡®çš„è‚¡ç¥¨ä»£ç æ ¼å¼
  const usMatch = upper.match(/\b([A-Z]{1,5})(?:-USD)?\b/);
  const hkMatch = upper.match(/\b(\d{4,5})\.?HK\b/i);
  const hkMatch2 = text.match(/æ¸¯è‚¡\s*(\d{4,5})/);
  const cryptoMatch = upper.match(/\b(BTC|ETH|SOL|BNB|XRP|ADA|DOGE|DOT)(?:-USD)?\b/);
  
  if (hkMatch) {
    ticker = hkMatch[1] + '.HK';
  } else if (hkMatch2) {
    ticker = hkMatch2[1] + '.HK';
  } else if (cryptoMatch) {
    ticker = cryptoMatch[1] + '-USD';
  } else if (usMatch && usMatch[1].length >= 2 && usMatch[1].length <= 5) {
    // æ£€æŸ¥æ˜¯å¦æ˜¯å¸¸è§è¯è€Œéè‚¡ç¥¨ä»£ç 
    const commonWords = ['THE', 'AND', 'FOR', 'ARE', 'BUT', 'NOT', 'YOU', 'ALL', 'CAN', 'HAD', 'HER', 'WAS', 'ONE', 'OUR', 'OUT'];
    if (!commonWords.includes(usMatch[1])) {
      ticker = usMatch[1];
    }
  }

  const loadingEl = appendMsg('ai', '<span class="msg-loading">ğŸ¤– æ€è€ƒä¸­...</span>', true);

  try {
    // çƒ­ç‚¹æ‰«æ - æ˜ç¡®çš„å‘½ä»¤
    if (/^(çƒ­ç‚¹|æ‰«æçƒ­ç‚¹|hot|trending)$/i.test(text.trim())) {
      loadingEl.innerHTML = 'æ­£åœ¨æ‰«æçƒ­ç‚¹èµ„äº§...';
      const r = await fetch('/api/hot');
      const data = await r.json();
      const items = data.trending || [];
      loadingEl.innerHTML = items.length
        ? `ğŸ”¥ <b>ä»Šæ—¥çƒ­ç‚¹</b><br><br>${items.slice(0,6).map(i => `â€¢ ${i.symbol || i.name}: ${i.reason || ''}`).join('<br>')}`
        : 'æš‚æ— çƒ­ç‚¹æ•°æ®ï¼Œè¯·ç¨åé‡è¯•ã€‚';
    } 
    // æ˜ç¡®çš„è‚¡ç¥¨åˆ†æå‘½ä»¤ (å¿…é¡»åŒæ—¶æœ‰è‚¡ç¥¨ä»£ç å’Œåˆ†æå…³é”®è¯)
    else if (ticker && /^(åˆ†æ|æŸ¥|çœ‹çœ‹|ç ”ç©¶)\s*.{0,10}$/i.test(text.replace(ticker, '').replace(/æ¸¯è‚¡|ç¾è‚¡|åŠ å¯†/g, ''))) {
      loadingEl.innerHTML = `ğŸ¤– æ­£åœ¨åˆ†æ <b>${ticker}</b>ï¼Œè¯·ç¨å€™...`;
      const [priceR, analyzeR] = await Promise.all([
        fetch(`/api/price/${ticker}`),
        fetch(`/api/analyze/${ticker}`),
      ]);
      const priceData = await priceR.json();
      const analyzeData = await analyzeR.json();
      
      if (priceData.error) {
        // å¦‚æœæŸ¥ä¸åˆ°ä»·æ ¼ï¼Œè®© AI å›ç­”
        const r = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: text })
        });
        const data = await r.json();
        loadingEl.innerHTML = data.reply ? data.reply.replace(/\n/g, '<br>') : 'æš‚æ— å›å¤';
      } else {
        const result = analyzeData[0] || analyzeData;
        const score = result.total_score || result.score;
        const rec = result.recommendation || result.signal || 'HOLD';
        const recColor = rec === 'BUY' ? '#3fb950' : rec === 'SELL' ? '#f85149' : '#e3b341';
        const chg = priceData.change_pct;
        const sign = chg >= 0 ? '+' : '';

        loadingEl.innerHTML = `
          <b>${ticker}</b> â€” ${priceData.name || ''}<br>
          ä»·æ ¼: <b>${priceData.price?.toFixed(2) || '--'}</b> &nbsp;
          æ¶¨è·Œ: <span style="color:${chg>=0?'#3fb950':'#f85149'}">${sign}${chg?.toFixed(2)}%</span><br><br>
          AIè¯„åˆ†: <b style="color:${recColor}">${score !== undefined ? (score*100).toFixed(0) : '--'} / 100</b><br>
          å»ºè®®: <b style="color:${recColor}">${rec}</b><br>
          ${result.ai_summary ? `<br>${result.ai_summary}` : ''}
        `;
        // åŒæ—¶æ›´æ–°å›¾è¡¨
        selectSymbol(ticker);
      }
    } 
    // å…¶ä»–æ‰€æœ‰æ¶ˆæ¯ - äº¤ç»™ AI å¤„ç†
    else {
      loadingEl.innerHTML = 'ğŸ¤– é¾™è™¾äº¤æ˜“åŠ©æ‰‹æ€è€ƒä¸­... <span id="chat-timer">(0s)</span>';
      
      // æ·»åŠ è¶…æ—¶è®¡æ—¶å™¨
      let seconds = 0;
      const timerEl = loadingEl.querySelector('#chat-timer');
      const timerInterval = setInterval(() => {
        seconds++;
        if (timerEl) timerEl.textContent = `(${seconds}s)`;
        // 8ç§’åæ˜¾ç¤ºæç¤º
        if (seconds === 8) {
          loadingEl.innerHTML += '<br><span style="color:var(--muted);font-size:11px;">ğŸ’¡ ç³»ç»Ÿç¹å¿™ï¼Œå»ºè®®ç”¨å¿«æ·å‘½ä»¤ï¼šåˆ†æ AAPL / æŸ¥è¯¢ BTC</span>';
        }
      }, 1000);
      
      try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 20000); // 20ç§’å‰ç«¯è¶…æ—¶
        
        const r = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: text, context: { activeSymbol, ticker } }),
          signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        clearInterval(timerInterval);
        
        if (!r.ok) throw new Error('Network error');
        const data = await r.json();
        loadingEl.innerHTML = data.reply ? data.reply.replace(/\n/g, '<br>') : 'æš‚æ— å›å¤';
      } catch (err) {
        clearInterval(timerInterval);
        if (err.name === 'AbortError') {
          loadingEl.innerHTML = 'â³ è¯·æ±‚è¶…æ—¶<br><br>ğŸ’¡ è¯•è¯•å¿«æ·å‘½ä»¤ï¼š<br>â€¢ åˆ†æ AAPL<br>â€¢ æŸ¥è¯¢ BTCä»·æ ¼<br>â€¢ æ‰«æçƒ­ç‚¹';
        } else {
          loadingEl.innerHTML = 'âš ï¸ è¿æ¥ä¸ç¨³å®š<br><br>ğŸ’¡ è¯·åˆ·æ–°é¡µé¢é‡è¯•ï¼Œæˆ–ä½¿ç”¨å·¦ä¾§å¿«æ·æ“ä½œ';
        }
      }
    }
  } catch(e) {
    loadingEl.innerHTML = 'âš ï¸ è¯·æ±‚å¤±è´¥<br><br>ğŸ’¡ è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ï¼Œæˆ–åˆ·æ–°é¡µé¢é‡è¯•';
  }

  scrollChat();
}

function appendMsg(role, html, returnEl = false) {
  const container = document.getElementById('chat-messages');
  const div = document.createElement('div');
  div.className = `msg ${role}`;
  div.innerHTML = html;
  container.appendChild(div);
  scrollChat();
  return returnEl ? div : null;
}

function scrollChat() {
  const c = document.getElementById('chat-messages');
  c.scrollTop = c.scrollHeight;
}

// â”€â”€ Agent åŠ¨æ€ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function addFeedItem(type, text) {
  const container = document.getElementById('feed-content');
  const now = new Date().toLocaleTimeString('zh', {hour:'2-digit',minute:'2-digit',second:'2-digit'});
  const div = document.createElement('div');
  div.className = `feed-item ${type}`;
  div.innerHTML = `<div class="feed-time">${now}</div>${text}`;
  container.insertBefore(div, container.firstChild);
  // æœ€å¤šä¿ç•™ 50 æ¡
  while (container.children.length > 50) container.removeChild(container.lastChild);
}

// â”€â”€ Tab åˆ‡æ¢ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchTab(name, btn) {
  ['chat','analysis','feed'].forEach(t => {
    document.getElementById(`tab-${t}`).style.display = t === name ? 'flex' : 'none';
  });
  document.querySelectorAll('.panel-tab').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  if (name === 'chat') scrollChat();
}

// â”€â”€ WebSocket å®æ—¶ä»·æ ¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function connectWS() {
  const proto = location.protocol === 'https:' ? 'wss' : 'ws';
  ws = new WebSocket(`${proto}://${location.host}/ws`);

  ws.onmessage = (e) => {
    const data = JSON.parse(e.data);
    if (data.type === 'price_tick' && data.symbol) {
      prices[data.symbol] = data;
      if (data.symbol === activeSymbol) updateHeader(data);
      // æ›´æ–°è‡ªé€‰è‚¡è¡Œ
      updateWatchlistRow(data);
    }
  };

  ws.onclose = () => setTimeout(connectWS, 5000);
  ws.onerror = () => ws.close();

  // å¿ƒè·³
  setInterval(() => { if (ws.readyState === WebSocket.OPEN) ws.send('ping'); }, 30000);
}

function updateWatchlistRow(data) {
  const el = document.getElementById(`wl-${data.symbol}`);
  if (!el) return;
  const priceEl = el.querySelector('.wl-price');
  const chgEl = el.querySelector('.wl-chg');
  if (priceEl && data.price) {
    priceEl.textContent = data.price.toFixed(data.price > 100 ? 2 : 4);
  }
  if (chgEl && data.change_pct !== undefined) {
    const sign = data.change_pct >= 0 ? '+' : '';
    chgEl.textContent = `${sign}${data.change_pct.toFixed(2)}%`;
    chgEl.style.color = data.change_pct >= 0 ? 'var(--green)' : 'var(--red)';
  }
}

// â”€â”€ é”®ç›˜å¿«æ·é”® â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener('keydown', (e) => {
  if (e.key === 'Enter' && document.activeElement === document.getElementById('search-input')) {
    addSymbol();
  }
});

// â”€â”€ åˆå§‹åŒ– â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
initChart();
connectWS();
loadWatchlist().then(() => {
  if (!activeSymbol) selectSymbol('AAPL');
});
addFeedItem('success', 'âœ… OpenClaw Trading OS å·²å¯åŠ¨');
</script>
</body>
</html>
