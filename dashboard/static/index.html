<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>OpenClaw Trading OS</title>
  <script src="https://unpkg.com/lightweight-charts@4.2.0/dist/lightweight-charts.standalone.production.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;700&family=IBM+Plex+Sans:wght@400;500;600&display=swap');

    :root {
      --bg: #0a1116;
      --panel: #101b22;
      --panel-2: #14232c;
      --line: #243946;
      --text: #e7f1f7;
      --muted: #8aa0af;
      --brand: #18c29c;
      --brand-soft: rgba(24, 194, 156, 0.18);
      --accent: #ff9f45;
      --up: #20cf85;
      --down: #ff5f67;
      --warn: #ffd166;
      --shadow: 0 12px 36px rgba(0, 0, 0, 0.35);
      --radius: 14px;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'IBM Plex Sans', 'Space Grotesk', sans-serif;
      background:
        radial-gradient(1200px 700px at 8% -20%, rgba(24,194,156,0.22), transparent 60%),
        radial-gradient(900px 500px at 98% -10%, rgba(255,159,69,0.16), transparent 55%),
        var(--bg);
      color: var(--text);
      min-height: 100vh;
      overflow: hidden;
    }

    .app {
      display: grid;
      grid-template-rows: 64px 1fr;
      height: 100vh;
    }

    .topbar {
      border-bottom: 1px solid var(--line);
      background: rgba(7, 14, 19, 0.8);
      backdrop-filter: blur(10px);
      padding: 0 20px;
      display: grid;
      grid-template-columns: 1fr auto auto;
      align-items: center;
      gap: 14px;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
      font-family: 'Space Grotesk', sans-serif;
      font-weight: 700;
      letter-spacing: .03em;
      font-size: 16px;
    }

    .brand .dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: var(--brand);
      box-shadow: 0 0 0 7px var(--brand-soft);
    }

    .status-cluster {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
      justify-content: flex-end;
    }
    .top-links {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }
    .link-chip {
      border: 1px solid var(--line);
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 11px;
      color: #b9d0de;
      text-decoration: none;
      background: rgba(16, 27, 34, 0.78);
      transition: .16s ease;
    }
    .link-chip:hover {
      color: var(--brand);
      border-color: #2d5c6f;
      transform: translateY(-1px);
    }

    .pill {
      border: 1px solid var(--line);
      border-radius: 999px;
      padding: 5px 10px;
      font-size: 11px;
      color: var(--muted);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: rgba(16, 27, 34, 0.8);
    }

    .pill .live-dot {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background: var(--up);
    }
    .live-dot.down { background: var(--down); }

    .btn {
      border: 1px solid var(--line);
      border-radius: 10px;
      background: linear-gradient(180deg, #1a2a34, #12202a);
      color: var(--text);
      padding: 8px 12px;
      font-size: 12px;
      cursor: pointer;
      transition: .16s ease;
    }

    .btn:hover { transform: translateY(-1px); border-color: #35657a; }
    .btn.primary {
      border-color: transparent;
      background: linear-gradient(140deg, #18c29c, #0fa57f);
      color: #072017;
      font-weight: 700;
    }

    .main {
      display: grid;
      grid-template-columns: 290px 1fr 360px;
      gap: 14px;
      padding: 14px;
      min-height: 0;
    }

    .panel {
      background: linear-gradient(180deg, rgba(20,35,44,.95), rgba(16,27,34,.95));
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      min-height: 0;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .panel-header {
      padding: 12px 14px;
      border-bottom: 1px solid var(--line);
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-family: 'Space Grotesk', sans-serif;
      font-size: 13px;
      letter-spacing: .02em;
    }

    .panel-body {
      padding: 12px;
      overflow: auto;
      min-height: 0;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .search {
      position: relative;
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 8px;
    }

    input, select, textarea {
      width: 100%;
      border: 1px solid var(--line);
      background: #0c151b;
      color: var(--text);
      border-radius: 10px;
      padding: 8px 10px;
      font-size: 12px;
      outline: none;
    }

    input:focus, select:focus, textarea:focus { border-color: #2f738e; }

    .dropdown {
      position: absolute;
      top: 42px;
      left: 0;
      right: 84px;
      max-height: 260px;
      overflow: auto;
      background: #0e1b23;
      border: 1px solid var(--line);
      border-radius: 10px;
      display: none;
      z-index: 10;
    }

    .dropdown.show { display: block; }

    .drop-item {
      padding: 8px 10px;
      border-bottom: 1px solid #1d2e38;
      cursor: pointer;
      font-size: 12px;
      display: flex;
      justify-content: space-between;
      gap: 8px;
    }

    .drop-item:hover { background: rgba(24,194,156,0.1); }

    .list {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .item {
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 9px;
      display: grid;
      grid-template-columns: 1fr auto auto auto;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      background: linear-gradient(180deg, rgba(14, 24, 31, 0.92), rgba(10, 19, 25, 0.9));
    }

    .item.active {
      border-color: #2d8b7f;
      background: rgba(24,194,156,.16);
      box-shadow: inset 0 0 0 1px rgba(24,194,156,.35);
    }
    .item small { color: var(--muted); }
    .watchlist-highlight {
      border: 1px solid #2f5f73;
      border-radius: 12px;
      padding: 10px;
      background: linear-gradient(180deg, rgba(18, 41, 52, 0.5), rgba(10, 23, 30, 0.5));
    }
    .watchlist-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
      font-family: 'Space Grotesk', sans-serif;
      font-size: 13px;
    }
    .watchlist-tag {
      font-size: 11px;
      color: #8ee9d2;
      border: 1px solid #2d7363;
      border-radius: 999px;
      padding: 2px 8px;
      background: rgba(24,194,156,.14);
    }

    .price-up { color: var(--up); font-weight: 600; }
    .price-down { color: var(--down); font-weight: 600; }
    .btn.danger {
      border-color: #6a2e33;
      background: linear-gradient(180deg, #3a1f24, #2e171c);
      color: #ffb8bf;
      padding: 5px 8px;
      font-size: 11px;
    }

    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }

    .chart-wrap {
      display: grid;
      grid-template-rows: auto 1fr auto;
      min-height: 0;
    }

    .symbol-head {
      padding: 12px 14px;
      border-bottom: 1px solid var(--line);
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 8px;
      align-items: center;
    }

    .symbol-name { font-size: 22px; font-family: 'Space Grotesk', sans-serif; font-weight: 700; }
    .quote { font-size: 18px; }

    #chart { min-height: 0; }

    .periods { display: flex; gap: 6px; padding: 10px 14px; border-top: 1px solid var(--line); }
    .periods button { flex: 1; }

    .tabs {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      border-bottom: 1px solid var(--line);
    }

    .tab {
      padding: 10px 8px;
      text-align: center;
      font-size: 12px;
      color: var(--muted);
      cursor: pointer;
      border-bottom: 2px solid transparent;
    }

    .tab.active { color: var(--text); border-bottom-color: var(--brand); background: rgba(24,194,156,.08); }

    .tab-pane { display: none; height: 100%; overflow: auto; padding: 12px; }
    .tab-pane.active { display: block; }

    .chat-box {
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 10px;
      background: rgba(8, 15, 20, 0.7);
      min-height: 180px;
      max-height: 320px;
      overflow: auto;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .msg { padding: 8px 10px; border-radius: 10px; font-size: 12px; line-height: 1.45; }
    .msg.user { background: #274150; align-self: flex-end; max-width: 88%; }
    .msg.ai { background: #13232d; border: 1px solid #22404f; max-width: 95%; }

    .meta-box {
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 10px;
      background: rgba(8, 15, 20, 0.7);
    }

    .row { display: flex; gap: 8px; align-items: center; }
    .row > * { flex: 1; }

    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; }
    .muted { color: var(--muted); }
    .tiny { font-size: 11px; }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }

    th, td {
      border-bottom: 1px solid #1e313c;
      text-align: left;
      padding: 7px 5px;
      white-space: nowrap;
    }

    .feed {
      max-height: 170px;
      overflow: auto;
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 8px;
      background: rgba(8,15,20,.6);
    }

    .feed-item {
      border-left: 2px solid var(--line);
      padding-left: 8px;
      margin-bottom: 8px;
      font-size: 11px;
      color: var(--muted);
    }

    .feed-item.ok { border-color: var(--up); }
    .feed-item.warn { border-color: var(--warn); }
    .feed-item.err { border-color: var(--down); }
    .banner {
      margin: 8px 14px 0;
      border: 1px solid #6b4d21;
      color: #ffd9a8;
      background: rgba(255, 159, 69, 0.12);
      border-radius: 10px;
      padding: 8px 10px;
      font-size: 12px;
      display: none;
    }
    .banner.show { display: block; }
    .banner.err {
      border-color: #7f2730;
      color: #ffd0d6;
      background: rgba(255, 95, 103, 0.15);
    }

    @media (max-width: 1180px) {
      body { overflow: auto; }
      .app { height: auto; min-height: 100vh; }
      .main {
        grid-template-columns: 1fr;
        grid-template-rows: auto auto auto;
      }
      .panel { min-height: 360px; }
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="topbar">
      <div class="brand">
        <span class="dot"></span>
        <span>OpenClaw 交易作战台</span>
      </div>
      <div class="status-cluster" id="status-cluster">
        <span class="pill"><span class="live-dot"></span><span id="health-text">服务健康: 检查中</span></span>
        <span class="pill" id="mode-pill">执行模式: --</span>
        <span class="pill" id="kill-pill">熔断开关: --</span>
        <span class="pill" id="api-pill">连接状态: 初始化</span>
      </div>
      <div class="top-links">
        <a class="link-chip" href="http://127.0.0.1:8765/#agent=trading-os&floor=operations-floor" target="_blank">进入 OpenClaw 交易Agent</a>
        <a class="link-chip" href="http://127.0.0.1:8765/" target="_blank">打开 OpenClaw HQ</a>
        <a class="link-chip" href="/api/agent/config" target="_blank">Agent 配置API</a>
        <a class="link-chip" href="/api/ai/config" target="_blank">AI 配置API</a>
        <a class="link-chip" href="/api/execution/config" target="_blank">执行配置API</a>
        <button class="btn" onclick="loadAllData()">刷新全局</button>
      </div>
    </div>
    <div id="access-banner" class="banner"></div>
    <div id="api-banner" class="banner err"></div>

    <div class="main">
      <section class="panel">
        <div class="panel-header">
          <span>自选列表</span>
          <span class="tiny muted mono" id="left-ts">--</span>
        </div>
        <div class="panel-body">
          <div class="search">
            <input id="search-input" placeholder="搜索标的: AAPL / 0700.HK / BTC-USD" autocomplete="off" />
            <button class="btn primary" onclick="addSymbol()">加入自选</button>
            <div class="dropdown" id="search-dropdown"></div>
          </div>

          <div class="meta-box">
            <div class="row" style="margin-bottom:8px">
              <button class="btn" onclick="loadWatchlist()">刷新自选</button>
              <button class="btn" onclick="addDemo()">加载示例</button>
            </div>
            <div class="watchlist-highlight">
              <div class="watchlist-header">
                <span>自选列表（核心）</span>
                <span class="watchlist-tag">优先监控</span>
              </div>
              <div class="list" id="watchlist"></div>
            </div>
          </div>

        </div>
      </section>

      <section class="panel chart-wrap">
        <div class="symbol-head">
          <div>
            <div class="symbol-name" id="symbol-name">AAPL</div>
            <div class="tiny muted" id="symbol-desc">--</div>
          </div>
          <div style="text-align:right">
            <div class="quote mono" id="symbol-price">--</div>
            <div class="tiny" id="symbol-change">--</div>
          </div>
        </div>
        <div id="chart"></div>
        <div class="periods">
          <button class="btn" onclick="changePeriod('1d', this)">1D</button>
          <button class="btn" onclick="changePeriod('5d', this)">5D</button>
          <button class="btn" onclick="changePeriod('1mo', this)">1M</button>
          <button class="btn" onclick="changePeriod('3mo', this)">3M</button>
          <button class="btn" onclick="changePeriod('6mo', this)">6M</button>
        </div>
      </section>

      <section class="panel">
        <div class="tabs">
          <div class="tab active" data-tab="chat" onclick="switchTab(this)">交易Agent</div>
          <div class="tab" data-tab="strategies" onclick="switchTab(this)">策略</div>
          <div class="tab" data-tab="risk" onclick="switchTab(this)">风控</div>
          <div class="tab" data-tab="activity" onclick="switchTab(this)">活动</div>
        </div>

        <div class="tab-pane active" id="tab-chat">
          <div class="meta-box" style="margin-bottom:10px">
            <div class="grid-2" style="margin-bottom:8px">
              <input id="agent-name" placeholder="Agent 名称" />
              <select id="agent-mode">
                <option value="advisor">advisor</option>
                <option value="semi_auto">semi_auto</option>
                <option value="auto">auto</option>
              </select>
              <select id="agent-style">
                <option value="concise">concise</option>
                <option value="standard">standard</option>
                <option value="deep">deep</option>
              </select>
              <select id="agent-risk">
                <option value="conservative">conservative</option>
                <option value="balanced">balanced</option>
                <option value="aggressive">aggressive</option>
              </select>
            </div>
            <div class="grid-2" style="margin-bottom:8px">
              <label class="tiny muted"><input type="checkbox" id="cap-market" /> market_brief</label>
              <label class="tiny muted"><input type="checkbox" id="cap-tech" /> technical_analysis</label>
              <label class="tiny muted"><input type="checkbox" id="cap-news" /> news_reasoning</label>
              <label class="tiny muted"><input type="checkbox" id="cap-portfolio" /> portfolio_review</label>
              <label class="tiny muted"><input type="checkbox" id="cap-risk" /> risk_guard</label>
              <label class="tiny muted"><input type="checkbox" id="cap-exec" /> execution_plan</label>
            </div>
            <div class="row">
              <button class="btn" onclick="loadAgentConfig()">加载配置</button>
              <button class="btn primary" onclick="saveAgentConfig()">保存 Agent 配置</button>
            </div>
          </div>

          <div class="chat-box" id="chat-box"></div>
          <div class="row" style="margin-top:8px">
            <textarea id="chat-input" rows="2" placeholder="输入你的交易问题，例如：分析 AAPL 并给出今天可执行计划"></textarea>
          </div>
          <div class="row" style="margin-top:8px">
            <button class="btn primary" onclick="sendChat()">发送</button>
            <button class="btn" onclick="quickAsk('给我当前持仓风险复盘')">风险复盘</button>
            <button class="btn" onclick="quickAsk('给我今天3条可执行交易计划')">行动计划</button>
          </div>
        </div>

        <div class="tab-pane" id="tab-strategies">
          <div class="meta-box" style="margin-bottom:10px">
            <div class="grid-2" style="margin-bottom:8px">
              <input id="st-name" placeholder="策略名称" />
              <input id="st-symbol" placeholder="代码" />
              <select id="st-market"><option>US</option><option>HK</option><option>Crypto</option></select>
              <input id="st-timeframe" placeholder="周期 (1d/4h)" value="1d" />
            </div>
            <button class="btn primary" onclick="createStrategy()">创建策略</button>
          </div>
          <div id="strategies-list"></div>
        </div>

        <div class="tab-pane" id="tab-risk">
          <div class="meta-box" style="margin-bottom:10px">
            <div class="grid-2" style="margin-bottom:8px">
              <select id="rule-type">
                <option value="max_order_notional_usd">max_order_notional_usd</option>
                <option value="max_orders_per_day">max_orders_per_day</option>
                <option value="max_position_value_usd">max_position_value_usd</option>
                <option value="allowed_symbols">allowed_symbols</option>
              </select>
              <input id="rule-name" placeholder="规则名称" />
            </div>
            <textarea id="rule-json" rows="3" class="mono" placeholder='{"usd": 5000}'></textarea>
            <button class="btn primary" style="margin-top:8px" onclick="createRule()">创建规则</button>
          </div>
          <div id="risk-list"></div>
        </div>

        <div class="tab-pane" id="tab-activity">
          <div class="meta-box" style="margin-bottom:10px">
            <button class="btn" onclick="loadOrdersPositionsRuns()">刷新活动</button>
          </div>
          <div class="meta-box" style="margin-bottom:8px">
            <div class="tiny muted" style="margin-bottom:6px">订单</div>
            <div id="orders-table"></div>
          </div>
          <div class="meta-box" style="margin-bottom:8px">
            <div class="tiny muted" style="margin-bottom:6px">持仓</div>
            <div id="positions-table"></div>
          </div>
          <div class="meta-box">
            <div class="tiny muted" style="margin-bottom:6px">Agent 执行记录</div>
            <div id="runs-table"></div>
          </div>
        </div>
      </section>
    </div>
  </div>

  <script>
    const state = {
      activeSymbol: 'AAPL',
      prices: {},
      period: '1d',
      ws: null,
      wsHeartbeatTimer: null,
      wsEnabled: true,
      chart: null,
      candle: null,
      apiOk: true,
      loadedTabs: {
        strategy: false,
        risk: false,
        activity: false,
      },
    };

    function setApiStatus(ok, msg = '') {
      state.apiOk = ok;
      const pill = document.getElementById('api-pill');
      const banner = document.getElementById('api-banner');
      const dot = document.querySelector('.pill .live-dot');
      if (!pill || !banner || !dot) return;
      if (ok) {
        pill.textContent = '连接状态: 在线';
        banner.classList.remove('show');
        dot.classList.remove('down');
      } else {
        pill.textContent = '连接状态: 断开';
        banner.classList.add('show');
        banner.innerHTML = `后端连接失败：${msg || '网络异常'}。<button class="btn" onclick="recoverConnection()">重连</button>`;
        dot.classList.add('down');
      }
    }

    function logFeed(text, level = 'ok') {
      const el = document.getElementById('feed');
      if (!el) {
        console.log(`[${level}] ${text}`);
        return;
      }
      const d = document.createElement('div');
      d.className = `feed-item ${level}`;
      const ts = new Date().toLocaleTimeString();
      d.innerHTML = `<div class="mono tiny">${ts}</div><div>${text}</div>`;
      el.prepend(d);
      while (el.children.length > 60) el.removeChild(el.lastChild);
    }

    async function api(path, options = {}, retry = 1) {
      const timeoutMs = options.timeoutMs || 10000;
      const { timeoutMs: _discard, ...fetchOptions } = options;
      const controller = new AbortController();
      const timer = setTimeout(() => controller.abort(), timeoutMs);
      try {
        const r = await fetch(path, { ...fetchOptions, signal: controller.signal });
        if (!r.ok) throw new Error(`${path} -> ${r.status}`);
        const json = await r.json();
        setApiStatus(true);
        return json;
      } catch (e) {
        if (retry > 0) {
          await new Promise((res) => setTimeout(res, 450));
          return api(path, options, retry - 1);
        }
        setApiStatus(false, e.message || '请求失败');
        throw e;
      } finally {
        clearTimeout(timer);
      }
    }

    async function recoverConnection() {
      try {
        await api('/api/health', {}, 0);
        await loadAllData();
      } catch (e) {
        setApiStatus(false, e.message || '重连失败');
      }
    }

    function initChart() {
      const container = document.getElementById('chart');
      state.chart = LightweightCharts.createChart(container, {
        layout: { background: { color: '#0f1b22' }, textColor: '#8aa0af' },
        grid: { vertLines: { color: '#1a2a34' }, horzLines: { color: '#1a2a34' } },
        rightPriceScale: { borderColor: '#274252' },
        timeScale: { borderColor: '#274252', timeVisible: true },
        width: container.clientWidth,
        height: container.clientHeight,
      });

      state.candle = state.chart.addCandlestickSeries({
        upColor: '#20cf85',
        downColor: '#ff5f67',
        wickUpColor: '#20cf85',
        wickDownColor: '#ff5f67',
        borderVisible: false,
      });

      window.addEventListener('resize', () => {
        state.chart.resize(container.clientWidth, container.clientHeight);
      });
    }

    async function switchTab(btn) {
      document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
      btn.classList.add('active');
      const tab = btn.dataset.tab;
      document.querySelectorAll('.tab-pane').forEach(x => x.classList.remove('active'));
      document.getElementById(`tab-${tab}`).classList.add('active');

      if (tab === 'strategy' && !state.loadedTabs.strategy) {
        await loadStrategies();
        state.loadedTabs.strategy = true;
      }
      if (tab === 'risk' && !state.loadedTabs.risk) {
        await loadRiskRules();
        state.loadedTabs.risk = true;
      }
      if (tab === 'activity' && !state.loadedTabs.activity) {
        await loadOrdersPositionsRuns();
        state.loadedTabs.activity = true;
      }
    }

    async function loadHealth() {
      try {
        const h = await api('/api/health');
        const mode = h.fixed_mode ? '固定稳定模式' : '标准模式';
        document.getElementById('health-text').textContent = `服务健康: ${h.ok ? '正常' : '异常'} | ${mode}`;
        state.wsEnabled = h.ws_enabled !== false;
      } catch {
        document.getElementById('health-text').textContent = '服务健康: 异常';
      }
    }

    async function loadExecutionConfig() {
      try {
        const cfg = await api('/api/execution/config');
        document.getElementById('mode-pill').textContent = `执行模式: ${cfg.mode}`;
        document.getElementById('kill-pill').textContent = `熔断开关: ${cfg.kill_switch ? '开启' : '关闭'}`;
      } catch (e) {
        logFeed(`加载执行配置失败: ${e.message}`, 'err');
      }
    }


    async function loadWatchlist() {
      const box = document.getElementById('watchlist');
      box.innerHTML = '';
      try {
        const items = await api('/api/watchlist');
        if (!items.length) {
          box.innerHTML = '<div class="tiny muted">自选列表为空，请先“加入自选”或“加载示例”。</div>';
          return;
        }
        items.forEach(item => {
          state.prices[item.symbol] = item;
          const d = document.createElement('div');
          const c = Number(item.change_pct || 0);
          d.className = `item ${item.symbol === state.activeSymbol ? 'active' : ''}`;
          d.innerHTML = `
            <div>
              <div class="mono">${item.symbol}</div>
              <small>${item.name || ''}</small>
            </div>
            <div class="mono">${item.price ? item.price.toFixed(item.price > 100 ? 2 : 4) : '--'}</div>
            <div class="${c >= 0 ? 'price-up' : 'price-down'} mono">${c >= 0 ? '+' : ''}${c.toFixed(2)}%</div>
            <button class="btn danger" onclick="removeSymbol(event,'${item.symbol}')">删除</button>
          `;
          d.onclick = () => selectSymbol(item.symbol);
          box.appendChild(d);
        });
      } catch (e) {
        box.innerHTML = `<div class="tiny muted">加载失败: ${e.message}</div>`;
      }
    }

    async function addDemo() {
      try {
        for (const sym of ['AAPL', 'NVDA', 'BTC-USD']) {
          await api(`/api/watchlist/${sym}`, { method: 'POST' });
        }
        await loadWatchlist();
        logFeed('示例标的已加载到自选列表', 'ok');
      } catch (e) {
        logFeed(`加载示例失败: ${e.message}`, 'err');
      }
    }

    async function addSymbol() {
      const input = document.getElementById('search-input');
      const sym = input.value.trim().toUpperCase().replace(/\s+/g, '');
      if (!sym) return;
      try {
        const r = await api(`/api/watchlist/${sym}`, { method: 'POST' });
        logFeed(r.success ? `${sym} 已加入自选` : `${sym} 加入失败: ${r.message}`, r.success ? 'ok' : 'warn');
        input.value = '';
        document.getElementById('search-dropdown').classList.remove('show');
        await loadWatchlist();
        if (r.success) selectSymbol(sym);
      } catch (e) {
        logFeed(`${sym} 加入失败: ${e.message}`, 'err');
      }
    }

    async function selectSymbol(sym) {
      state.activeSymbol = sym;
      await Promise.all([loadPrice(sym), loadChart(sym, state.period), loadWatchlist()]);
    }

    async function removeSymbol(e, sym) {
      e.stopPropagation();
      try {
        await api(`/api/watchlist/${sym}`, { method: 'DELETE' });
        logFeed(`${sym} 已从自选移除`, 'ok');
        if (state.activeSymbol === sym) {
          state.activeSymbol = 'AAPL';
        }
        await loadWatchlist();
      } catch (err) {
        logFeed(`删除 ${sym} 失败: ${err.message}`, 'err');
      }
    }

    async function loadPrice(sym) {
      const data = await api(`/api/price/${sym}`);
      if (data.error) return;
      state.prices[sym] = data;
      const p = Number(data.price || 0);
      const c = Number(data.change_pct || 0);
      document.getElementById('symbol-name').textContent = data.symbol || sym;
      document.getElementById('symbol-desc').textContent = data.name || '';
      document.getElementById('symbol-price').textContent = `${data.currency || ''} ${p ? p.toFixed(p > 100 ? 2 : 4) : '--'}`;
      const changeEl = document.getElementById('symbol-change');
      changeEl.textContent = `${c >= 0 ? '+' : ''}${c.toFixed(2)}%`;
      changeEl.className = `tiny ${c >= 0 ? 'price-up' : 'price-down'}`;
    }

    async function loadChart(sym, period) {
      const data = await api(`/api/chart/${sym}?period=${period}`);
      if (!data || !data.data || !data.data.length) return;
      const candles = data.data
        .map(d => ({
          time: Math.floor(new Date(d.date).getTime() / 1000),
          open: d.open, high: d.high, low: d.low, close: d.close,
        }))
        .filter(d => d.open && d.high && d.low && d.close)
        .sort((a, b) => a.time - b.time);

      state.candle.setData(candles);
      state.chart.timeScale().fitContent();
    }

    function changePeriod(period, btn) {
      state.period = period;
      document.querySelectorAll('.periods .btn').forEach(x => x.classList.remove('primary'));
      btn.classList.add('primary');
      loadChart(state.activeSymbol, period);
    }

    async function createStrategy() {
      const payload = {
        name: document.getElementById('st-name').value.trim(),
        market: document.getElementById('st-market').value,
        symbol: document.getElementById('st-symbol').value.trim().toUpperCase(),
        timeframe: document.getElementById('st-timeframe').value.trim() || '1d',
        config: {},
      };
      if (!payload.name || !payload.symbol) return;
      const r = await api('/api/strategies', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });
      logFeed(`策略创建成功 #${r.strategy_id}`, 'ok');
      await loadStrategies();
    }

    async function loadStrategies() {
      const rows = await api('/api/strategies');
      const box = document.getElementById('strategies-list');
      if (!rows.length) {
        box.innerHTML = '<div class="tiny muted">暂无策略，请先创建。</div>';
        return;
      }
      box.innerHTML = `<table><thead><tr><th>名称</th><th>代码</th><th>状态</th></tr></thead><tbody>${rows.map(r =>
        `<tr><td>${r.name}</td><td class="mono">${r.symbol}</td><td>${r.status}</td></tr>`).join('')}</tbody></table>`;
    }

    async function createRule() {
      const type = document.getElementById('rule-type').value;
      const name = document.getElementById('rule-name').value.trim() || type;
      let value = {};
      try { value = JSON.parse(document.getElementById('rule-json').value || '{}'); } catch {
        logFeed('风控规则 JSON 格式错误', 'err');
        return;
      }

      await api('/api/risk-rules', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ rule_type: type, name, value, enabled: true }),
      });
      logFeed(`风控规则已创建: ${type}`, 'ok');
      await loadRiskRules();
    }

    async function loadRiskRules() {
      const rows = await api('/api/risk-rules');
      const box = document.getElementById('risk-list');
      if (!rows.length) {
        box.innerHTML = '<div class="tiny muted">暂无风控规则。</div>';
        return;
      }
      box.innerHTML = `<table><thead><tr><th>名称</th><th>类型</th><th>启用</th></tr></thead><tbody>${rows.map(r =>
        `<tr><td>${r.name}</td><td class="mono">${r.rule_type}</td><td>${r.enabled ? '是' : '否'}</td></tr>`).join('')}</tbody></table>`;
    }

    async function loadOrdersPositionsRuns() {
      const [orders, positions, runs] = await Promise.all([
        api('/api/orders?limit=20'),
        api('/api/positions'),
        api('/api/agent-runs?limit=20'),
      ]);

      document.getElementById('orders-table').innerHTML = renderTable(
        ['id', 'symbol', 'side', 'order_type', 'quantity', 'status'],
        orders
      );
      document.getElementById('positions-table').innerHTML = renderTable(
        ['symbol', 'quantity', 'avg_cost', 'last_price', 'unrealized_pnl'],
        positions
      );
      document.getElementById('runs-table').innerHTML = renderTable(
        ['id', 'run_type', 'status', 'started_at', 'error'],
        runs
      );
    }

    function renderTable(cols, rows) {
      if (!rows.length) return '<div class="tiny muted">暂无数据。</div>';
      return `<table><thead><tr>${cols.map(c => `<th>${c}</th>`).join('')}</tr></thead><tbody>${rows.map(r =>
        `<tr>${cols.map(c => `<td class="${c.includes('id') || c.includes('symbol') ? 'mono' : ''}">${r[c] ?? ''}</td>`).join('')}</tr>`).join('')}</tbody></table>`;
    }

    async function loadAgentConfig() {
      const cfg = await api('/api/agent/config');
      document.getElementById('agent-name').value = cfg.agent_name || '';
      document.getElementById('agent-mode').value = cfg.mode || 'advisor';
      document.getElementById('agent-style').value = cfg.response_style || 'standard';
      document.getElementById('agent-risk').value = cfg.risk_level || 'balanced';
      document.getElementById('cap-market').checked = !!cfg.capabilities?.market_brief;
      document.getElementById('cap-tech').checked = !!cfg.capabilities?.technical_analysis;
      document.getElementById('cap-news').checked = !!cfg.capabilities?.news_reasoning;
      document.getElementById('cap-portfolio').checked = !!cfg.capabilities?.portfolio_review;
      document.getElementById('cap-risk').checked = !!cfg.capabilities?.risk_guard;
      document.getElementById('cap-exec').checked = !!cfg.capabilities?.execution_plan;
    }

    async function saveAgentConfig() {
      const payload = {
        agent_name: document.getElementById('agent-name').value.trim() || 'OpenClaw Trading Strategist',
        mode: document.getElementById('agent-mode').value,
        response_style: document.getElementById('agent-style').value,
        risk_level: document.getElementById('agent-risk').value,
        capabilities: {
          market_brief: document.getElementById('cap-market').checked,
          technical_analysis: document.getElementById('cap-tech').checked,
          news_reasoning: document.getElementById('cap-news').checked,
          portfolio_review: document.getElementById('cap-portfolio').checked,
          risk_guard: document.getElementById('cap-risk').checked,
          execution_plan: document.getElementById('cap-exec').checked,
        }
      };
      const res = await api('/api/agent/config', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });
      logFeed(`Agent 配置已保存: ${res.profile.agent_name}`, 'ok');
    }

    function appendChat(role, text) {
      const box = document.getElementById('chat-box');
      const d = document.createElement('div');
      d.className = `msg ${role}`;
      d.innerHTML = text.replace(/\n/g, '<br>');
      box.appendChild(d);
      box.scrollTop = box.scrollHeight;
    }

    async function quickAsk(msg) {
      document.getElementById('chat-input').value = msg;
      await sendChat();
    }

    async function sendChat() {
      const input = document.getElementById('chat-input');
      const text = input.value.trim();
      if (!text) return;
      input.value = '';
      appendChat('user', text);
      appendChat('ai', '思考中...');
      const loading = document.querySelector('#chat-box .msg.ai:last-child');
      try {
        const res = await api('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: text, context: { activeSymbol: state.activeSymbol } }),
        });
        loading.innerHTML = (res.reply || 'no reply').replace(/\n/g, '<br>');
      } catch (e) {
        loading.innerHTML = `请求失败: ${e.message}`;
      }
    }

    function connectWS() {
      if (!state.wsEnabled) return;
      const proto = location.protocol === 'https:' ? 'wss' : 'ws';
      state.ws = new WebSocket(`${proto}://${location.host}/ws`);

      state.ws.onmessage = (e) => {
        const data = JSON.parse(e.data);
        if (data.type === 'price_tick' && data.symbol) {
          state.prices[data.symbol] = data;
          if (data.symbol === state.activeSymbol) {
            loadPrice(data.symbol);
          }
        }
      };

      state.ws.onclose = () => {
        if (state.wsEnabled) {
          setApiStatus(false, '实时连接断开');
          setTimeout(connectWS, 4000);
        }
      };

      if (state.wsHeartbeatTimer) clearInterval(state.wsHeartbeatTimer);
      state.wsHeartbeatTimer = setInterval(() => {
        if (state.ws && state.ws.readyState === WebSocket.OPEN) state.ws.send('ping');
      }, 30000);
    }

    const searchInput = document.getElementById('search-input');
    const searchDropdown = document.getElementById('search-dropdown');
    let searchTimer = null;

    searchInput.addEventListener('input', () => {
      clearTimeout(searchTimer);
      const q = searchInput.value.trim();
      if (!q) {
        searchDropdown.classList.remove('show');
        return;
      }
      searchTimer = setTimeout(() => doSearch(q), 150);
    });

    async function doSearch(q) {
      const rows = await api(`/api/search?q=${encodeURIComponent(q)}`);
      if (!rows.length) {
        searchDropdown.classList.remove('show');
        return;
      }
      searchDropdown.innerHTML = rows.map(r =>
        `<div class="drop-item" onclick="pickSearch('${r.symbol}')"><span class="mono">${r.symbol}</span><span class="muted">${r.market}</span></div>`
      ).join('');
      searchDropdown.classList.add('show');
    }

    function pickSearch(sym) {
      searchInput.value = sym;
      searchDropdown.classList.remove('show');
      addSymbol();
    }

    async function loadAllData() {
      document.getElementById('left-ts').textContent = new Date().toLocaleTimeString();
      await loadHealth();
      await loadExecutionConfig();
      await loadWatchlist();
      await loadPrice(state.activeSymbol);
      await loadChart(state.activeSymbol, state.period);
      await loadAgentConfig();
    }

    async function pingHealth() {
      try {
        const h = await api('/api/health', { timeoutMs: 2500 }, 0);
        const shouldEnableWs = h.ws_enabled !== false;
        if (shouldEnableWs && !state.wsEnabled) {
          state.wsEnabled = true;
          connectWS();
        } else if (!shouldEnableWs && state.wsEnabled) {
          state.wsEnabled = false;
          if (state.ws) state.ws.close();
          if (state.wsHeartbeatTimer) clearInterval(state.wsHeartbeatTimer);
        }
      } catch {}
    }

    function ensureAccessMode() {
      const banner = document.getElementById('access-banner');
      if (location.protocol === 'file:') {
        banner.classList.add('show');
        banner.innerHTML = '当前是本地文件打开，接口不可用。请改用 <span class="mono">http://127.0.0.1:8080/</span> 访问。';
      }
    }

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && document.activeElement === searchInput) addSymbol();
      if (e.key === 'Enter' && (e.metaKey || e.ctrlKey) && document.activeElement === document.getElementById('chat-input')) sendChat();
    });

    initChart();
    ensureAccessMode();
    loadAllData().then(() => {
      if (state.wsEnabled) connectWS();
    });
    setInterval(pingHealth, 8000);
    changePeriod('1d', document.querySelector('.periods .btn'));
    appendChat('ai', '交易Agent工作台已就绪。先确认上方 Agent 配置，再输入你的交易问题。');
  </script>
</body>
</html>
